"use strict";class AppLiveChat extends HTMLElement{events={CONNECTED:"connected",DISCONNECTED:"disconnected",CONNECTION_LOST:"connection_lost",CONNECTION_RESTORED:"connection_restored",CONNECTION_RECOVERED:"connection_recovered",CONNECTION_UNSTABLE:"connection_unstable",USER_IS_TYPING:"user_is_typing",USER_STOPPED_TYPING:"user_stopped_typing",USER_JOINED_CHAT:"user_joined_chat",USER_LEFT_CHAT:"user_left_chat",USER_DATA:"user_data",USER_REMOVED_FROM_CHAT:"user_removed_from_chat",INCOMING_CHAT:"incoming_chat",INCOMING_EVENT:"incoming_event",CUSTOMER_ID:"customer_id",CUSTOMER_UPDATED:"customer_updated",CHAT_DEACTIVATED:"chat_deactivated",AVAILABILITY_UPDATED:"availability_updated",INCOMING_GREETING:"incoming_greeting",INCOMING_TYPING_INDICATOR:"incoming_typing_indicator",USER_ADDED_TO_CHAT:"user_added_to_chat",CHAT_TRANSFERRED:"chat_transferred",CHAT_PROPERTIES_UPDATED:"chat_properties_updated",EVENT_PROPERTY_UPDATED:"event_properties_updated",EVENT_UPDATED:"event_updated",MARKED_AS_SEEN:"events_marked_as_seen",QUEUE_POSITION_UPDATED:"queue_position_updated",ACCESS_TOKEN_EXPIRED:"access_token_expired",USERS_LIMIT_REACHED:"users_limit_reached",INACTIVITY_TIMEOUT:"inactivity_timeout"};historyStates={DONE:"DONE",INACTIVE:"INACTIVE",LOADING:"LOADING"};state={isModelOpen:!1,queue:null,chat:null,lastThreadId:null,active:!1,activating:!1,soundEnable:!1,users:{},pendingMessages:[],historyStatus:this.historyStates.INACTIVE,history:null,customerId:null,customer:null,isAgentAcceptingChat:!1,isAgentOnline:!1,availability:!1,activeAgent:null,activeAgentId:null,totalChats:0,currentForm:"ticket",sendTranscript:!1,wholeChatHistoryLoaded:!1,uploadedFile:null,form:{prechat:_theme.Helpers.getItemFromSS("_livechat_prechat")||{icon:_theme.liveChatIcons.user,submitBtnText:"Start Chat",type:"prechat"},ticket:_theme.Helpers.getItemFromSS("_livechat_ticket")||{icon:_theme.liveChatIcons.user,submitBtnText:"Leave a message",successMsg:"Thank you!. your message has been sent. our support will contact you soon.",type:"ticket"},postchat:_theme.Helpers.getItemFromSS("_livechat_postchat")||{icon:_theme.liveChatIcons.star,submitBtnText:"Submit",type:"postchat"}}};templates={liveChatIcons:_theme.liveChatIcons,formSection:`
            <div data-livechat-form-inner>
                [[Form_Header_Html]]
                <form>
                    <p class="indicator-for-star">All fields marked with <em>*</em> are required</p>
                    [[Form_Group_Html]]
                    <div class="form-cta"><button type="submit" class="btn btn-pink" aria-controls="livechat-sr-only">[[Form_Submit_Btn_Text]]</button></div>
                </form>
            </div>
            <div data-livechat-form-status aria-hidden="true"><span>${_theme.liveChatIcons.checkmark}</span><p>Thank you! Your message has been sent. Our support team will contact you soon.</p></div>
            `,formHeader:'<div class="livechat-form-header"><span>[[Form_Header_Icon_Html]]</span><h2>[[Form_Header_Text]]</h2></div>',input:'<input autocomplete="[[Input_AutoComplete_Name]]" type="[[Input_Type]]" id="[[Input_Id]]" name="[[Input_Name]]" required aria-required="true" [[Input_Attr]] />',radioInput:'<label><input type="radio" name="[[Input_Name]]" value="[[Input_Value]]" [[Input_Checked]] [[Input_Attr]] /><span>[[Input_Title]]</span></label>',textarea:'<textarea autocomplete="[[Input_AutoComplete_Name]]" id="[[Input_Id]]" name="[[Input_Name]]" [[Input_Attr]]></textarea>',label:'<label for="[[Input_Id]]"><span>[[Input_Title]]</span><em aria-hidden="true">*</em></label>',formGroup:'<div [[Field_Id]] class="form-group [[Input_Wrapper_Class]]">[[Input_Html]][[Input_Label_Html]]</div>',formGroupCheckbox:`
        <div [[Field_Id]] class="form-group [[Input_Wrapper_Class]]">
            <span>[[Input_Checkbox_Label]]</span>
            <div class="form-group-inner">
                [[Input_Html]]
                [[Input_Label_Html]]
            </div>
        </div>`,chatSection:`
                    <div class="chat-list" data-chat-list></div>
                    <div class="chat-action">
                        <button type="button" aria-hidden="true" aria-label="Start chat" class="btn btn-pink hidden" data-chat-resume>Start chat</button>
                        <div data-chat-input-wrapper>
                            <p class="hidden" role="alert" data-livechat-typing-alert></p>
                            <div class="chat-action-cta">
                                <textarea class="scroller" aria-label="Write a message" aria-description="Agent is online now" placeholder="Write a message..." data-chat-input></textarea>
                                <button aria-controls="livechat-sr-only" type="button" class="outline-inset" data-livechat-file-upload-btn aria-label="Upload a file" aria-description="Maximum file size 10MB">
                                    ${_theme.liveChatIcons.file}
                                </button>
                                <button aria-label="Send message" aria-controls="livechat-sr-only" type="button" data-chat-input-send class="btn btn-pink outline-inset"><span class="visually-hidden">Send message</span>${_theme.liveChatIcons.send}</button>
                            </div>
                        </div>
                        <div aria-hidden="true" aria-modal="true" role="dialog" aria-label="File preview" data-livechat-file-preview-modal>
                            <div class="file-preview-inner">
                                <div class="file-preview-header">
                                    <div class="file-preview-header-left">
                                        <span class="icon-wrapper">${_theme.liveChatIcons.checkmark}</span>
                                        <span data-file-preview-count></span>
                                    </div>
                                    <div class="file-preview-header-right">
                                        <button class="btn btn-outlined" type="button" data-toggle-preview-modal aria-label="minimize file preview modal">
                                            <span class="visually-hidden">minimize file preview modal</span>
                                            ${_theme.liveChatIcons.chevronDown}
                                        </button>
                                    </div>
                                </div>
                                <div class="file-preview-body">
                                    <div class="file-preview-body-inner scroller"></div>
                                    <div class="file-preview-footer">
                                        <button type="button" aria-label="Send file" class="btn btn-pink">Send files</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`,filePreviewItemHtml:`
            <div class="preview-file" role="listitem">
                <div class="img [[File_Wrapper_Class]]">
                    [[File_Type_Html]]
                    <div class="preview-file-action" [[File_Preview_Action_Role]]>
                        [[File_Preview_Edit_Btn]]
                        [[File_Preview_Remove_Btn]]
                    </div>
                </div>
                <p>[[File_Name]]</p>
            </div>`,thread:'<div data-date="[[Chat_Date]]" class="message-thread [[Chat_Thread_Class]]">[[Chat_Thread_Html]]</div>',threadStartDate:'<div class="message-thread-start-date"><span>[[Msg_Thread_Start_Date]]</span></div>',ticketFormOffline:`<div class="message-form message-form-ticket"><span class="message-form-icon">${_theme.liveChatIcons.checkmark}</span><p>Thank you! Your message has been sent. Our support team will contact you soon.</p></div>`,preChatFormItem:"<li><span>[[Msg_Form_Input_Name]]</span><span>[[Msg_Form_Input_Value]]</span></li>",preChatForm:`<div class="message-form message-form-[[Form_Type]]">
                        <span class="message-form-icon">[[Form_Icon]]</span>
                        <ul>[[Msg_Form_Input_Items]]</ul>
                    </div>`,fileMessage:'<div data-id="[[Msg_Id]]" class="message-container [[Msg_TypeClass]] type-file"><div class="file-wrapper"><a tabindex="-1" href="[[File_Url]]" target="_blank" title="opens in a new window" rel="noopener noreferrer">[[File_Type_Html]]</a></div></div>',message:`<div data-id="[[Msg_Id]]" class="message-container [[Msg_TypeClass]]">
                    [[Msg_Avatar]]
                    <div class="message">
                        <div class="message-meta">
                            [[Msg_User_Name]]
                            [[Msg_Timestamp]]
                        </div>
                        <p class="message-text">[[Msg_ChatText]]</p>
                    </div>
                </div>`,systemMsg:'<div class="message-container type-system">[[Msg_Text]]</div>',transcriptModal:`<div class="transcript-modal" aria-modal="true" aria-hidden="true">
            <div class="transcript-modal-inner">
                <div class="transcript-modal-header">
                    <button type="button" aria-label="close transcript modal" data-close-modal>
                        <span class="visually-hidden">close transcript modal</span>
                        &times;
                    </button>
                </div>
                <div class="transcript-modal-body">
                    <span class="transcript-modal-icon">${_theme.liveChatIcons.mail}</span>
                    <p data-transcript-text>Send the chat transcript to your e-mail.</p>
                    <button class="btn btn-pink hidden btn-transcript-hide" type="button" aria-label="Hide transcript modal" data-close-modal>Hide</button>
                    <form>
                        <div class="form-group">
                            <label class="visually-hidden" for="transcript-email">Email</label>
                            <input required aria-required="true" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+.[a-z]{2,}$" type="email" name="email" placeholder="Enter your email" autocomplete="email" id="transcript-email" />
                        </div>
                        <div class="form-group">
                            <button aria-controls="livechat-sr-only" type="submit" class="btn btn-pink">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`,agent:`<div class="livechat-agent">
                    <div class="livechat-agent-inner">
                        <div class="livechat-agent-img">[[Agent_Img]]</div>
                        <div class="livechat-agent-info">
                            <div>[[Agent_Name]]</div>
                            <div>[[Agent_Job_Title]]</div>
                        </div>
                        <div class="livechat-agent-action">
                            <button aria-label="Rate as good and open comment modal" type="button" data-agent-like>
                                <span class="visually-hidden">Rate as good and open comment modal</span>
                                ${_theme.liveChatIcons.like}
                            </button>
                            <button aria-label="Rate as bad and open comment modal" type="button" data-agent-dislike>
                                <span class="visually-hidden">Rate as bad and open comment modal</span>
                                ${_theme.liveChatIcons.dislike}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="agent-modal" aria-hidden="true" aria-modal="true">
                    <div class="agent-modal-inner">
                        <div class="agent-modal-header">
                            <button type="button" aria-label="close transcript modal" data-close-modal>
                                <span class="visually-hidden">close transcript modal</span>
                                &times;
                            </button>
                        </div>
                        <div class="agent-modal-body">
                            <span class="agent-modal-icon">${_theme.liveChatIcons.like}</span>
                            <p data-text>Thank you for the rating! You can also leave a comment:</p>
                            <form>
                                <div class="form-group">
                                    <label class="visually-hidden" for="customer-comment">comment</label>
                                    <textarea required aria-required="true" name="comment" placeholder="Comment" autocomplete="comment" id="customer-comment"></textarea>
                                </div>
                                <div class="form-group">
                                    <button aria-controls="livechat-sr-only" type="submit" class="btn btn-pink">Leave a comment</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>`};settings={allowedInputTypes:["header","checkbox","email","name","question","subject","textarea","group_chooser","radio","select"],groupId:void 0!==_theme.settings.livechat_groupId?_theme.settings.livechat_groupId:3};elements={};constructor(){super()}connectedCallback(){this.init()}disconnectedCallback(){this.destroyEvents()}static get getElementName(){return"live-chat"}init=async()=>{window.CustomerSDK&&(this.customerSDK=CustomerSDK.init({licenseId:12834777,clientId:"2d0f932cf27c60a5a40b2a8af7d29692",groupId:this.settings.groupId,uniqueGroups:!0}),this.initLiveChatListener())};getPredictedAgent=async()=>{try{let t=await this.customerSDK.getPredictedAgent({groupId:this.settings.groupId});return t?.hasOwnProperty("queue")&&t.queue?(this.state.availability=!1,this.state.activeAgent=null,this.state.activeAgentId=null,this.state.isAgentOnline=!1):(this.state.activeAgent=t.agent,this.state.activeAgentId=t.agent.id,this.state.isAgentOnline=!!this.state.activeAgent,this.state.currentForm=this.state.activeAgent?"prechat":"ticket"),t}catch(e){return this.state.availability=!1,this.state.activeAgent=null,this.state.activeAgentId=null,this.state.isAgentOnline=!1,!1}};initLiveChatListener=()=>{this.elements.footerLoader=document.querySelector("footer.footer-wrapper .support-chat .footer-pane-loader"),_theme.isMobile&&this.elements.footerLoader&&this.elements.footerLoader.classList.remove("hide"),this.customerSDK.on(this.events.CONNECTED,this.onConnected),this.customerSDK.on(this.events.INCOMING_CHAT,this.handleChatStart),this.customerSDK.on(this.events.USER_DATA,this.onUserData),this.customerSDK.on(this.events.USER_REMOVED_FROM_CHAT,this.onUserRemovedFromChat),this.customerSDK.on(this.events.INCOMING_EVENT,this.onIncomingEvent),this.customerSDK.on(this.events.CHAT_DEACTIVATED,this.onChatDeactivated),this.customerSDK.on(this.events.QUEUE_POSITION_UPDATED,this.onQueuePosUpdated),this.customerSDK.on(this.events.CHAT_TRANSFERRED,this.onChatTrasferred),this.customerSDK.on(this.events.AVAILABILITY_UPDATED,this.onAvailabilityUpdated),this.customerSDK.on(this.events.CUSTOMER_ID,this.onCustomerId),this.customerSDK.on(this.events.CUSTOMER_UPDATED,this.onCustomerUpdated),this.customerSDK.on(this.events.USER_ADDED_TO_CHAT,this.onUserAddedToChat),this.customerSDK.on(this.events.MARKED_AS_SEEN,t=>{setTimeout(()=>{this.onMarkSeen(t)},250)}),this.customerSDK.on(this.events.DISCONNECTED,this.onDisconnected),this.customerSDK.on(this.events.CONNECTION_LOST,this.onConnectionLost),this.customerSDK.on(this.events.CONNECTION_RESTORED,this.onConnectionRestored),this.customerSDK.on(this.events.CONNECTION_RECOVERED,this.onConnectionRecovered),this.customerSDK.on(this.events.CONNECTION_UNSTABLE,this.onConnectionUnstable),this.customerSDK.on(this.events.INCOMING_TYPING_INDICATOR,this.handleTypingIndicator),window.addEventListener("beforeunload",t=>{this.customerSDK.disconnect(),this.destroyEvents()})};renderForm=t=>{if(!t||!t.enabled)return!1;let e=this.templates.formSection,s=this.templates.formHeader,a="",i=t.fields.filter(t=>"header"!==t.type),r=t.fields.find(t=>"header"===t.type);i.forEach(e=>{let s=this.templates.formGroup,i="",r="";if("postchat"!==t.type||"comment"===e.type){let n="checkbox"===e.type?e.type:"email"===e.type?"email":"text";s="checkbox"===n?this.templates.formGroupCheckbox:s,i=this.templates.label;let l=`livechat-input-${e.id}`;r="textarea"===e.type||"comment"===e.type?this.templates.textarea:this.templates.input,r=_theme.Helpers.updateHtml(r,"[[Input_AutoComplete_Name]]",["name","email"].includes(e.type)?e.type:"off"),r=_theme.Helpers.updateHtml(r,"[[Input_Type]]",n),r=_theme.Helpers.updateHtml(r,"[[Input_Name]]","checkbox"===n?e.label:e.type),r=_theme.Helpers.updateHtml(r,"[[Input_Id]]",l),i=_theme.Helpers.updateHtml(i,"[[Input_Id]]",l),"checkbox"===e.type?(i=_theme.Helpers.updateHtml(i,"[[Input_Title]]",e.options[0].label),r=_theme.Helpers.updateHtml(r,"[[Input_Attr]]",e.options[0].checked?'checked="checked"':"")):(r=_theme.Helpers.updateHtml(r,"[[Input_Attr]]",e.required?'required aria-required="true"':""),i=_theme.Helpers.updateHtml(i,"[[Input_Title]]",e.label)),"comment"===e.type?(r=_theme.Helpers.updateHtml(r,"required",""),r=_theme.Helpers.updateHtml(r,"aria-required",""),i=_theme.Helpers.updateHtml(i,'<em aria-hidden="true">*</em>',""),s=_theme.Helpers.updateHtml(s,"[[Field_Id]]",`data-id="${e.id}"`),s=_theme.Helpers.updateHtml(s,"[[Input_Wrapper_Class]]","hidden")):(s=_theme.Helpers.updateHtml(s,"[[Input_Wrapper_Class]]",_theme.Helpers.handleize(`field-${e.type}`)),s=_theme.Helpers.updateHtml(s,"[[Field_Id]]",""))}else{let o=`field-${e.id}`;i=`<p id="${o}">[[Input_Label_Html]]</p>`,i=_theme.Helpers.updateHtml(i,"[[Input_Label_Html]]",e.label),e.options.forEach((t,s)=>{let a=this.templates.radioInput;a=_theme.Helpers.updateHtml(a,"[[Input_Name]]",e.label),a=_theme.Helpers.updateHtml(a,"[[Input_Value]]",t.label),a=_theme.Helpers.updateHtml(a,"[[Input_Checked]]",t.checked||""),"rating"===e.type?(a=_theme.Helpers.updateHtml(a,"[[Input_Attr]]",0===s?`required data-rate-input data-val="${t.value}"`:`data-rate-input data-val="${t.value}"`),a=_theme.Helpers.updateHtml(a,"[[Input_Title]]",t.title)):(a=_theme.Helpers.updateHtml(a,"[[Input_Attr]]",0===s?`required data-val="${t.label}"`:`data-val="${t.label}"`),a=_theme.Helpers.updateHtml(a,"[[Input_Title]]",t.label)),r+=a}),s=_theme.Helpers.updateHtml(s,"[[Input_Wrapper_Class]]",""),s=_theme.Helpers.updateHtml(s,"[[Field_Id]]",`role="radiogroup" aria-labelledby="${o}" data-id="${e.id}"`)}s="checkbox"===e.type?_theme.Helpers.updateHtml(s,"[[Input_Checkbox_Label]]",`${e.label}${e.required&&'<em aria-hidden="true">*</em>'}`):_theme.Helpers.updateHtml(s,"[[Input_Checkbox_Label]]",""),s=_theme.Helpers.updateHtml(s,"[[Input_Label_Html]]",i),a+=s=_theme.Helpers.updateHtml(s,"[[Input_Html]]",r)}),s=_theme.Helpers.updateHtml(s,"[[Form_Header_Icon_Html]]",t.icon),s="postchat"!==t.type?_theme.Helpers.updateHtml(s,"[[Form_Header_Text]]",r?r.label:""):_theme.Helpers.updateHtml(s,"<h2>[[Form_Header_Text]]</h2>",""),e=_theme.Helpers.updateHtml(e,"[[Form_Header_Html]]",s),e=_theme.Helpers.updateHtml(e,"[[Form_Group_Html]]",a),e=_theme.Helpers.updateHtml(e,"[[Form_Submit_Btn_Text]]",t.submitBtnText),this.elements.formContainer.innerHTML=e,this.state.currentForm=t.type,this.elements.form=this.querySelector("dialog [data-livechat-form] [data-livechat-form-inner] form"),this.elements.formContainerInner=this.querySelector("[data-livechat-form-inner]"),this.elements.formSubmitBtn=this.elements.form.querySelector(".form-cta button"),this.elements.formStatus=this.querySelector("[data-livechat-form-status]"),this.elements.form.setAttribute("data-type",t.type),this.state.form.elements={},"postchat"!==t.type&&this.elements.form.querySelectorAll("input, textarea").forEach(t=>{this.state.form.elements["radio"===t.type?t.dataset.val:t.name]=t,"email"===t.type&&t.addEventListener("change",e=>{_theme.Helpers.validateEmail(t.value.trim())?t.setCustomValidity(""):t.setCustomValidity("Invalid email")})}),"postchat"===t.type&&this.elements.form.querySelectorAll('input[type="radio"], textarea').forEach(t=>{this.state.form.elements["comment"===t.name?t.name:t.dataset.val]=t,t.type&&"radio"===t.type&&t.addEventListener("input",e=>{t.closest(".form-group").querySelectorAll('input[type="radio"]').forEach(t=>{t.setCustomValidity("")}),void 0!==t.dataset.rateInput&&this.elements.form.querySelector("textarea").closest(".form-group").classList.remove("hidden")},{once:!0})}),this.elements.form.removeEventListener("submit",this.handleFormSubmit),this.elements.form.addEventListener("submit",this.handleFormSubmit)};renderChat=()=>{let t=this.querySelector("[data-livechat-upload-file]");if(t)return;let e=document.createElement("div");e.innerHTML='<label><span class="visually-hidden">Upload a file</span><input aria-label="Upload a file" class="hidden" data-livechat-upload-file type="file" name="file" accept="audio/*,video/*,image/*,.pdf" /></label>',this.appendChild(e.firstChild),this.elements.chatSection=this.elements.chatSection||this.querySelector("[data-livechat-chats]"),this.elements.chatSection.innerHTML=this.templates.chatSection,this.elements.fileUploader=this.querySelector("[data-livechat-upload-file]")};renderAgentProfile=(t,e)=>{let s=this.querySelector(".livechat-agent");if(s){if(e){let a=this.querySelectorAll(".livechat-agent .livechat-agent-info > div");a.forEach((e,s)=>{e.textContent=0===s?t.name:t.jobTitle})}this.showAgent();return}let i=this.templates.agent,r=`<img src="${t.avatar}" alt="agent avatar" />`;i=_theme.Helpers.updateHtml(i,"[[Agent_Img]]",r),i=_theme.Helpers.updateHtml(i,"[[Agent_Name]]",t.name),i=_theme.Helpers.updateHtml(i,"[[Agent_Job_Title]]",t.jobTitle);let n=document.createElement("div");n.innerHTML=i,this.elements.chatModalHeaderBottom.appendChild(n.firstChild),this.elements.chatModalHeaderBottom.closest(".livechat-header").appendChild(n.lastChild),this.style.setProperty("--chatmodal-header-height","120px");let l=this.querySelector(".livechat-agent [data-agent-like]"),o=this.querySelector(".livechat-agent [data-agent-dislike]"),h=this.querySelector(".agent-modal [data-close-modal]"),d=this.querySelector(".agent-modal p[data-text]"),c=this.querySelector(".agent-modal form"),m=this.querySelector(".agent-modal form textarea"),u=this.querySelector(".agent-modal .agent-modal-icon"),p=1;l.addEventListener("click",async t=>{p=1,u.innerHTML=_theme.liveChatIcons.like,this.showAgentCommentModal(l);try{await this.sendAgentRating(p),o.classList.remove("active"),l.classList.add("active")}catch(e){this.handleError(e.message)}}),o.addEventListener("click",async t=>{p=0,u.innerHTML=_theme.liveChatIcons.dislike,this.showAgentCommentModal(o);try{await this.sendAgentRating(p),o.classList.add("active"),l.classList.remove("active")}catch(e){this.handleError(e.message)}}),h.addEventListener("click",this.hideAgentCommentModal),c.addEventListener("submit",async t=>{t.preventDefault();try{this.showLoader(),await this.sendAgentRating(p,m.value.trim()),d.textContent="Submitted sucessfully!",c.classList.add("hidden"),this.hideLoader(),0===p?(o.classList.add("active"),l.classList.remove("active")):(o.classList.remove("active"),l.classList.add("active")),setTimeout(()=>{this.hideAgentCommentModal(),d.textContent="Thank you for the rating! You can also leave a comment:",c.classList.remove("hidden"),0===p?o.focus():l.focus()},3e3)}catch(e){this.handleError(e.message),this.hideAgentCommentModal(),d.textContent="Thank you for the rating! You can also leave a comment:",c.classList.remove("hidden"),0===p?o.focus():l.focus()}})};renderTranscriptModal=()=>{let t=this.querySelector(".transcript-modal");if(t)return;let e=document.createElement("div");e.innerHTML=this.templates.transcriptModal,this.elements.chatModal=this.elements.chatModal||this.querySelector("dialog"),this.elements.chatModal.append(e.firstChild)};renderPreviewFiles=t=>{if(!t||0===t.length)return;this.querySelector("[data-livechat-file-preview-modal]");let e=this.querySelector("[data-livechat-file-preview-modal] .file-preview-body-inner"),s="",a=URL.createObjectURL(t[0]);t.forEach(t=>{let e=this.templates.filePreviewItemHtml,i="",r="",n=`
                <button type="button" class="btn btn-svg" data-preview-remove aria-label="Remove file">
                    <span class="visually-hidden">Remove file</span>
                    ${_theme.liveChatIcons.trash}
                </button>`;if(t.type.includes("image/")&&(r="file--img",i=`<img src="${a}" alt="${t.name}" />`),t.type.includes("audio/")&&(r="file--audio",i=`<audio controls src="${a}">Your browser does not support the audio element.</audio>`),t.type.includes("video/")&&(r="file--video",i=`<video width="200" height="140" controls src="${a}">Your browser does not support the video element.</video>`),t.type.includes("application/pdf")&&(r="file--pdf",i=`<div class="preview-pdf">${_theme.liveChatIcons.doc}</div>`),e=_theme.Helpers.updateHtml(e,"[[File_Wrapper_Class]]",r),e=_theme.Helpers.updateHtml(e,"[[File_Type_Html]]",i),e=_theme.Helpers.updateHtml(e,"[[File_Name]]",t.name),e=_theme.Helpers.updateHtml(e,"[[File_Preview_Remove_Btn]]",n),t.type.includes("image/")){let l=`
                    <button type="button" class="btn btn-svg" data-preview-add-alt aria-label="add alternative text">
                        <span class="visually-hidden">add alternative text</span>
                        ${_theme.liveChatIcons.editPen}
                        <span aria-hidden="true">alt text</span>
                    </button>`;e=_theme.Helpers.updateHtml(e,"[[File_Preview_Edit_Btn]]",l),e=_theme.Helpers.updateHtml(e,"[[File_Preview_Action_Role]]",'role="group"')}else e=_theme.Helpers.updateHtml(e,"[[File_Preview_Action_Role]]",""),e=_theme.Helpers.updateHtml(e,"[[File_Preview_Edit_Btn]]","");s+=e}),e.innerHTML=s,this.showFilePreviewModal();let i=e.querySelectorAll("[data-preview-add-alt]"),r=e.querySelectorAll("[data-preview-remove]");i.forEach(t=>{t.classList.add("hidden")}),i.forEach(t=>{t.addEventListener("click",t=>{})}),r.forEach(e=>{e.addEventListener("click",e=>{this.state.uploadedFile=null,URL.revokeObjectURL(a),this.alertStatus(`Selected file ${t[0].name} has been removed`),this.hideFilePreviewModal()})})};updateModalHeaderHeight=()=>{let t=this.querySelector("[data-livechat-queue]"),e=this.querySelector(".livechat-agent"),s=58;t&&(s+=t.clientHeight),e&&(s+=e.clientHeight),this.style.setProperty("--chatmodal-header-height",`${s}px`)};handleTypingIndicator=t=>{if(!t.chatId||!t.typingIndicator)return;let{authorId:e,isTyping:s}=t.typingIndicator;if(s){let a=this.state.users[e];this.elements.typingAlert.textContent=`${a.name} is typing...`,this.elements.typingAlert.classList.remove("hidden")}else this.elements.typingAlert.textContent="",this.elements.typingAlert.classList.add("hidden")};initPostEvents=()=>{this.state.uploadedFile=null;let t=this.querySelector("[data-livechat-sound]"),e=this.querySelector("[data-livechat-file-preview-modal] .file-preview-footer button"),s=this.querySelector(".toggle-switch input"),a=this.querySelector("[data-livechat-file-preview-modal] [data-toggle-preview-modal]"),i=this.querySelector(".chatclose-modal [data-chatclose-close-btn]"),r=this.querySelector(".chatclose-modal [data-chat-deactive-btn]"),n=this.querySelector("[data-chat-resume]"),l=this.querySelector("[data-livechat-queue]"),o=this.querySelector("[data-livechat-queue] [data-livechat-queue-toggle]");this.elements.openChatModalBtns.forEach(t=>{t.addEventListener("click",this.openChatModal)}),this.elements.closeChatModalBtn.addEventListener("click",this.closeChatModal),this.elements.moreOptionsBtn.addEventListener("click",this.showMoreOptions),this.elements.moreOptionsDropdown.addEventListener("focusout",this.handleMoreOptionsFocusOut),this.elements.closeChatBtn.addEventListener("click",this.showCloseChatModal),i&&i.addEventListener("click",this.hideCloseChatModal),r&&r.addEventListener("click",this.handleCloseChat),this.elements.fileUploaderBtn.addEventListener("click",t=>{this.elements.fileUploader.showPicker("showPicker")}),this.elements.fileUploader.addEventListener("change",t=>{let e=t.target.files[0];e&&t.target.value&&(this.state.uploadedFile=e,this.renderPreviewFiles([e]))}),e.addEventListener("click",t=>{this.state.uploadedFile&&this.sendFileMessage(this.state.uploadedFile)}),t.addEventListener("click",t=>{s.click()}),s.addEventListener("change",t=>{s.checked?(this.state.soundEnable=!0,this.updateSrOnlyContent("Notification sounds enabled")):(this.state.soundEnable=!1,this.updateSrOnlyContent("Notification sounds disabled"))}),a.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();let e=a.closest("[data-livechat-file-preview-modal]");if(!e)return;let s=e.querySelector(".file-preview-body");s.toggleAttribute("open"),null!==s.getAttribute("open")?(s.removeAttribute("aria-hidden"),this.alertStatus("File preview modal is maximized")):(s.setAttribute("aria-hidden",!0),this.alertStatus("File preview modal is minimized"))}),n&&n.addEventListener("click",this.startChat),this.elements.sendTranscriptBtn.addEventListener("click",this.showTranscriptModal),this.elements.tModalCloseBtns.forEach(t=>{t.addEventListener("click",this.hideTranscriptModal)}),this.elements.tModalForm.addEventListener("submit",async t=>{if(t.preventDefault(),!this.state.sendTranscript)return;this.showLoader();let e=this.elements.tModalEmailInput.value,s=_theme.Helpers.validateEmail(e);if(s)try{this.updateSrOnlyContent("Please wait, submitting request"),this.showLoader(),await this.sendTranscript(e),this.showSendTranscriptSuccessMsg(e),this.hideLoader()}catch(a){this.handleError(a.message)}}),o&&o.addEventListener("click",t=>{null!==l.getAttribute("open")?(l.removeAttribute("open"),o.setAttribute("aria-label","show more"),o.querySelector("span").textContent="show more"):(l.setAttribute("open",""),o.setAttribute("aria-label","show less"),o.querySelector("span").textContent="show less"),this.updateModalHeaderHeight()}),this.initMsgInputEvents()};sendTypingAlert=async t=>{try{await this.sendEvent({type:"custom",custom_id:this.getCustomId("user-typing-"),content:{typingIndicator:{authorId:this.state.customerId,isTyping:t}}})}catch(e){console.error(e)}};initMsgInputEvents=()=>{let t,e,s;this.elements.chatSendBtn.addEventListener("click",this.handleMessage),this.elements.chatInput.addEventListener("keydown",this.onChatInputPressEnter),this.elements.chatInput.addEventListener("input",async a=>{clearTimeout(e),s||(s=!0,t=setTimeout(async()=>{let t=this.elements.chatInput.value;t&&""!==t?await this.sendTypingAlert(!0):await this.sendTypingAlert(!1),s=!1},300))}),this.elements.chatInput.addEventListener("keyup",async t=>{clearTimeout(e);let a=this.elements.chatInput.value;a&&""!==a||(e=setTimeout(()=>{s=!1,this.sendTypingAlert(!1)},300))})};initOnScrollEvent=()=>{if(0===this.state.totalChats||this.state.wholeChatHistoryLoaded)return;let t=this.querySelector("[data-history-loader]"),e=_theme.Helpers.throttle((e,s)=>{let a=e[0].isIntersecting;if(this.state.isLoadingHistory===this.historyStates.LOADING)return;if(this.state.wholeChatHistoryLoaded){s.unobserve(e[0].target);return}let i=t.querySelector("svg");a?(i||(t.innerHTML=_theme.liveChatIcons.loading,i=t.querySelector("svg")),this.state.isLoadingHistory=this.historyStates.LOADING,this.loadHistory(this.state.chat).then(t=>{this.state.isLoadingHistory=this.historyStates.DONE,i&&i.remove()}).catch(t=>{this.state.isLoadingHistory=this.historyStates.DONE,_theme.Helpers.showNotification(t.message),i&&i.remove()})):i&&i.remove()}),s=new IntersectionObserver(e,{root:this.elements.chatModalBody,rootMargin:"20px 0px 0px 0px",threshold:.05});s.observe(t)};destroyEvents=()=>{let t=this.querySelector(".chatclose-modal [data-chatclose-close-btn]"),e=this.querySelector(".chatclose-modal [data-chat-deactive-btn]");this.customerSDK.off(this.events.CONNECTED,this.onConnected),this.elements.openChatModalBtns.forEach(t=>{t.removeEventListener("click",this.openChatModal)}),this.elements.closeChatModalBtn.removeEventListener("click",this.closeChatModal),this.elements.moreOptionsBtn.removeEventListener("click",this.showMoreOptions),this.elements.chatSendBtn.removeEventListener("click",this.handleMessage),this.elements.chatInput.removeEventListener("keydown",this.onChatInputPressEnter),this.elements.moreOptionsDropdown.removeEventListener("focusout",this.handleMoreOptionsFocusOut),this.elements.closeChatBtn.removeEventListener("click",this.showCloseChatModal),t&&t.removeEventListener("click",this.hideCloseChatModal),e&&e.removeEventListener("click",this.handleCloseChat)};buildinitialSelectors=()=>{this.elements.chatModal=this.querySelector("dialog"),this.elements.chatModalHeaderBottom=this.querySelector("dialog .livechat-header .livechat-header-bottom"),this.elements.chatModalBody=this.querySelector("dialog [data-livechat-body]"),this.elements.openChatModalBtns=document.querySelectorAll("[data-livechat-trigger]"),this.elements.closeChatModalBtn=this.querySelector("[data-livechat-close-modal]"),this.elements.formContainer=this.querySelector("[data-livechat-form]"),this.elements.formContainerInner=this.querySelector("[data-livechat-form-inner]"),this.elements.chatSection=this.querySelector("[data-livechat-chats]"),this.elements.moreOptionsBtn=this.querySelector("[data-livechat-more]"),this.elements.moreOptionsDropdown=this.querySelector(".livechat-more-menu"),this.elements.closeChatBtn=this.querySelector("[data-livechat-close-chat]"),this.elements.fileUploader=this.querySelector("[data-livechat-upload-file]"),this.elements.fileUploaderBtn=this.querySelector("[data-livechat-file-upload-btn]"),this.elements.chatInputWrapper=this.querySelector("[data-livechat-chats] .chat-action"),this.elements.chatInputWrapperInner=this.querySelector("[data-livechat-chats] .chat-action [data-chat-input-wrapper]"),this.elements.chatList=this.querySelector("[data-chat-list]"),this.elements.typingAlert=this.querySelector("[data-livechat-typing-alert]"),this.elements.chatInput=this.querySelector("[data-chat-input]"),this.elements.chatSendBtn=this.querySelector("[data-chat-input-send]"),this.elements.sendTranscriptBtn=this.querySelector("[data-livechat-send-transcript]"),this.elements.tModal=this.querySelector(".transcript-modal"),this.elements.tModalForm=this.querySelector(".transcript-modal form"),this.elements.tModalCloseBtns=this.querySelectorAll(".transcript-modal [data-close-modal]"),this.elements.tModalEmailInput=this.querySelector('.transcript-modal input[type="email"]'),this.elements.tModalText=this.querySelector(".transcript-modal [data-transcript-text]"),this.elements.tModalHideBtn=this.querySelector(".transcript-modal .btn-transcript-hide"),this.elements.tModalEmailInput.value=this.state.customer?.email};removeFileFromFileList=(t,e)=>{let s=new DataTransfer;for(let a=0;a<t.length;a++)e!==a&&s.items.add(t[a]);return s.files};showFilePreviewModal=()=>{let t=this.querySelector("[data-livechat-file-preview-modal]");if(!t)return;let e=t.querySelector(".file-preview-body-inner");e.setAttribute("role","list"),t.setAttribute("aria-hidden",!1),setTimeout(()=>{_theme.focusTrap($(t),t=>{this.hideFilePreviewModal()},null,null,!0)},250)};hideFilePreviewModal=()=>{let t=this.querySelector("[data-livechat-file-preview-modal]");if(!t)return;this.elements.fileUploader.value="";let e=t.querySelector(".file-preview-body-inner");e.removeAttribute("role"),e.innerHTML="",t.setAttribute("aria-hidden",!0),this.elements.fileUploaderBtn.focus()};showQueueInfo=()=>{let t=this.querySelector("[data-livechat-queue]");if(!t)return;let e=t.querySelector("[data-livechat-queue-position]"),s=t.querySelector("[data-livechat-queue-waiting-time]");e.textContent=this.state.queue.position,s.textContent=Math.floor(this.state.queue.waitTime/60),this.hideFormSection(),t.setAttribute("aria-hidden",!1),this.elements.chatSection.classList.add("h-full"),this.updateModalHeaderHeight()};hideQueueinfo=()=>{let t=this.querySelector("[data-livechat-queue]");t&&(t.setAttribute("aria-hidden",!0),this.elements.chatSection.classList.remove("h-full"),this.updateModalHeaderHeight())};showAgent=()=>{let t=this.querySelector(".livechat-agent");t&&(t.classList.remove("hidden"),this.updateModalHeaderHeight())};hideAgent=()=>{let t=this.querySelector(".livechat-agent");t&&(t.classList.add("hidden"),this.updateModalHeaderHeight())};showAgentCommentModal=t=>{let e=this.querySelector(".agent-modal");e&&(e.setAttribute("aria-hidden",!1),_theme.focusTrap($(e),e=>{this.hideAgentCommentModal(),t&&t.focus()},null,null,!0))};hideAgentCommentModal=()=>{let t=this.querySelector(".agent-modal");t&&t.setAttribute("aria-hidden",!0)};showFormSection=()=>{this.elements.formContainer.removeAttribute("aria-hidden"),this.elements.formContainer.classList.remove("hidden")};hideFormSection=()=>{this.elements.formContainer.setAttribute("aria-hidden",!0),this.elements.formContainer.classList.add("hidden")};showForm=()=>{this.elements.formContainerInner.removeAttribute("aria-hidden"),this.elements.formContainerInner.classList.remove("hidden")};hideForm=()=>{this.elements.formContainerInner.setAttribute("aria-hidden",!0),this.elements.formContainerInner.classList.add("hidden")};showChatSection=()=>{this.elements.chatSection.classList.remove("hidden")};hideChatSection=()=>{this.elements.chatSection.classList.add("hidden")};showChatStartBtn=()=>{let t=this.querySelector("[data-chat-resume]");t&&(t.setAttribute("aria-hidden",!1),t.classList.remove("hidden"))};hideChatStartbtn=()=>{let t=this.querySelector("[data-chat-resume]");t&&(t.setAttribute("aria-hidden",!0),t.classList.add("hidden"))};showChatInput=()=>{this.elements.chatInputWrapperInner.removeAttribute("aria-hidden"),this.elements.chatInputWrapperInner.classList.remove("hidden"),this.elements.chatInput.focus()};hideChatInput=()=>{this.elements.chatInputWrapperInner.setAttribute("aria-hidden",!0),this.elements.chatInputWrapperInner.classList.add("hidden")};trapDialogueFocus=t=>{_theme.focusTrap($(this.elements.chatModal),(e,s)=>{let a=s.target.closest("[aria-modal]");a||this.closeChatModal(t)},null,null,!0)};openChatModal=t=>{let e=this.elements.chatModal.getAttribute("open");if(e||""===e){this.closeChatModal();return}this.state.isModelOpen=!0,this.elements.chatModal.show?this.elements.chatModal.show():this.elements.chatModal.setAttribute("open",!0),this.elements.openChatModalBtns.forEach(t=>{t.setAttribute("aria-hidden",!0)}),this.updateModalHeaderHeight(),this.scrollToBottom(),this.trapDialogueFocus(t)};closeChatModal=t=>{this.state.isModelOpen=!1,this.elements.chatModal.close?this.elements.chatModal.close():this.elements.chatModal.removeAttribute("open"),this.elements.openChatModalBtns.forEach(t=>{t.setAttribute("aria-hidden",!1)}),t&&t.target?t.target.focus():_theme.isMobile?_theme.focusFirstTabbable(document.querySelector("footer .support-chat"),'[role="button"]'):this.querySelector("[data-livechat-trigger]").focus(),this.alertStatus("Chat Modal is minimized")};handleMoreOptionsFocusOut=t=>{!t.relatedTarget||this.elements.moreOptionsDropdown.contains(t.relatedTarget)||this.hideMoreOptions()};showMoreOptions=()=>{let t=this.elements.moreOptionsDropdown.getAttribute("open");if(t){this.hideMoreOptions();return}this.elements.moreOptionsDropdown.setAttribute("open",!0),this.elements.moreOptionsBtn.setAttribute("aria-expanded",!0)};hideMoreOptions=()=>{this.elements.moreOptionsDropdown.removeAttribute("open"),this.elements.moreOptionsBtn.setAttribute("aria-expanded",!1)};scrollToBottom=t=>{this.elements.chatModalBody.scrollTop=t||this.elements.chatModalBody.scrollHeight};createFileMessage=(t,e,s,a)=>{if(!t||!e)return;let i=t.type,r=`${Math.floor(1e7*Math.random())}`;this.state.lastMsgId=r;let n=this.templates.fileMessage,l=a?"type-agent":"type-customer";n=_theme.Helpers.updateHtml(n,"[[Msg_Id]]",r),n=_theme.Helpers.updateHtml(n,"[[Msg_TypeClass]]",l),n=_theme.Helpers.updateHtml(n,"[[File_Url]]",e);let o="";i.includes("image/")&&(o=`<img src="${e}" alt="${t.name}" />`),i.includes("audio/")&&(o=`<audio controls src="${e}">Your browser does not support the audio element.</audio>`),i.includes("video/")&&(o=`<video width="200" height="140" controls src="${e}">Your browser does not support the video element.</video>`),n=_theme.Helpers.updateHtml(n,"[[File_Type_Html]]",o);let h=document.createElement("div");return h.innerHTML=n,s?n:h.firstChild};createMessage=(t,e,s,a,i)=>{let r=this.templates.message,n=this.isAgent(s),l=s.avatar?`<img class="agent-avatar" src="${s.avatar}" alt="avatar" aria-hidden="true" />`:"";r=_theme.Helpers.updateHtml(r,"[[Msg_Id]]",t),r=_theme.Helpers.updateHtml(r,"[[Msg_TypeClass]]",n?"type-agent":"type-customer"),r=_theme.Helpers.updateHtml(r,"[[Msg_Avatar]]",l),r=_theme.Helpers.updateHtml(r,"[[Msg_User_Name]]",`<span>${s.name}</span>`),r=_theme.Helpers.updateHtml(r,"[[Msg_Timestamp]]",`<span>${a?_theme.Helpers.getFormattedTime(a):""}</span>`),r=_theme.Helpers.updateHtml(r,"[[Msg_ChatText]]",e);let o=document.createElement("div");return o.innerHTML=r,i?r:o.firstChild};prependMessages=t=>{t.reverse().forEach(t=>{let e=this.elements.chatList.children[0];if(e){this.elements.chatList.insertBefore(t,e);return}this.appendMessage(t)})};appendMessage=t=>{this.elements.chatCurrentThread=this.elements.chatCurrentThread||this.querySelector("[data-chat-list] .message-thread.thread-active"),this.elements.chatCurrentThread?this.elements.chatCurrentThread.appendChild(t):this.elements.chatList.appendChild(t),this.scrollToBottom()};isAtTheBottom=(t,e=20)=>t.scrollTop+t.clientHeight>=t.scrollHeight-e;showLoader=()=>{let t=this.querySelector("[data-chat-loader]");t&&t.classList.remove("hidden")};hideLoader=()=>{let t=this.querySelector("[data-chat-loader]");t&&t.classList.add("hidden")};markAsFailedMessage=t=>{};confirmMessageAsSent=t=>{};validateForm=()=>{let t={status:!0};return"postchat"===this.state.currentForm?this.elements.form.querySelectorAll(".form-group").forEach(e=>{let s=e.querySelector("textarea");if(s)t[s.name]=s.value;else{let a=e.querySelector('input[type="radio"]:checked');a?void 0!==a.dataset.rateInput?t.score=a.dataset.val:t[a.dataset.val]=a.dataset.val:t.status=!1}}):this.elements.form.querySelectorAll("input, textarea").forEach(e=>{t[e.name]=e.value;let s=e.type?e.type:"text",a=e.value.trim(),i=!0;"checkbox"===s&&e.required&&!e.checked&&(i=!1),""===a?i=!1:"email"!==s||_theme.Helpers.validateEmail(a)||(i=!1),i||(t.status=!1)}),t};addErrorElement=(t,e)=>{let s=document.createElement("p");s.textContent=e||("textarea"===t.name?"Message":t.name)+" field is required",s.setAttribute("role","alert"),s.classList.add("input-error"),t.parentElement.append(s)};removeErrorElement=t=>{if(!t)return;let e=t.querySelector(".input-error");e&&e.remove()};showSendTranscriptSuccessMsg=t=>{let e=this.querySelector(".transcript-modal");if(!e)return;this.elements.tModalForm.classList.add("hidden"),this.elements.tModalForm.setAttribute("aria-hidden",!0);let s=`Chat transcript will be sent to ${t} once the chat is finished.`;this.elements.tModalText.textContent=s,this.elements.tModalHideBtn.classList.remove("hidden"),this.updateSrOnlyContent(`submitted successfully, ${s}`),_theme.focusTrap($(this.elements.tModal),t=>{this.showMoreOptions(),this.elements.sendTranscriptBtn.focus()},null,null,!0)};resetSendTrasnscriptModal=()=>{let t=this.querySelector(".transcript-modal");if(t){this.elements.tModalForm.removeAttribute("aria-hidden"),this.elements.tModalForm.classList.remove("hidden");this.elements.tModalText.textContent="Send the chat transcript to your e-mail.",this.elements.tModalHideBtn.classList.add("hidden")}};enableSendTranscript=()=>{this.elements.sendTranscriptBtn&&(this.elements.sendTranscriptBtn.disabled=!1,this.state.sendTranscript=!0,this.querySelectorAll(".livechat-agent-action button").forEach(t=>{t.disabled=!1}))};disableSendTranscript=()=>{this.elements.sendTranscriptBtn&&(this.elements.sendTranscriptBtn.disabled=!0,this.state.sendTranscript=!1,this.querySelectorAll(".livechat-agent-action button").forEach(t=>{t.disabled=!0}))};handleCloseChat=async()=>{if(this.state.active&&this.state.chat)try{return this.hideCloseChatModal(),this.showLoader(),await this.customerSDK.deactivateChat({id:this.state.chat}),this.hideLoader(),this.elements.closeChatModalBtn.focus(),!0}catch(t){this.handleError(t.message)}};showCloseChatModal=()=>{let t=this.querySelector(".chatclose-modal");t&&(t.setAttribute("aria-hidden",!1),_theme.focusTrap($(t),t=>{this.hideCloseChatModal(),this.elements.closeChatBtn.focus()},null,null,!0))};hideCloseChatModal=()=>{let t=this.querySelector(".chatclose-modal");t&&(t.setAttribute("aria-hidden",!0),this.elements.closeChatBtn.focus())};showCloseChatBtn=()=>{if(!this.state.chat||!this.state.active){this.hideCloseChatBtn(),console.error("No active thread found");return}this.elements.closeChatBtn.classList.remove("hidden"),this.elements.closeChatBtn.disabled=!1,this.elements.closeChatBtn.removeAttribute("tabindex"),this.elements.closeChatBtn.removeAttribute("aria-hidden")};hideCloseChatBtn=()=>{this.elements.closeChatBtn.classList.add("hidden"),this.elements.closeChatBtn.disabled=!0,this.elements.closeChatBtn.setAttribute("tabindex",-1),this.elements.closeChatBtn.setAttribute("aria-hidden",!0)};showTranscriptModal=t=>{this.state.sendTranscript&&(this.elements.tModal.setAttribute("aria-hidden",!1),_theme.focusTrap($(this.elements.tModal),e=>{this.showMoreOptions(),this.hideTranscriptModal(),t.target.focus()},null,null,!0))};hideTranscriptModal=t=>{this.elements.tModal.setAttribute("aria-hidden",!0),t&&t.pointerId&&-1===t.pointerId&&0===t.buttons&&(this.showMoreOptions(),this.elements.sendTranscriptBtn.focus())};displayTicketSuccessMsg=t=>{if(!t||t.id)return;let e=this.elements.formStatus.querySelector("p");e.textContent=this.state.form.ticket.successMsg,this.elements.formStatus.setAttribute("aria-hidden",!1),e.setAttribute("role","alert"),setTimeout(()=>{this.elements.form.reset(),this.hideForm(),_theme.focusTrap($(this.elements.chatModal),(t,e)=>{let s=e.target.closest("[aria-modal]");s||this.closeChatModal()},null,null,!0)},300)};alertStatus=t=>{let e=this.querySelector("[data-livechat-alert]");t&&e&&(e.classList.remove("hidden"),e.textContent=t,setTimeout(()=>{e.classList.add("hidden"),e.textContent=""},3e3))};updateSrOnlyContent=t=>{let e=this.querySelector("#livechat-sr-only");e&&(e.textContent=t||"",setTimeout(()=>{e.textContent=""},2e3))};renderBaseOnStatus=()=>{if(this.state.chat&&this.state.activeAgent)this.hideFormSection(),this.showChatSection(),this.state.active?(this.hideChatStartbtn(),this.showChatInput()):(this.hideChatInput(),this.showChatStartBtn());else{let t=this.state.activeAgent?"prechat":"ticket";this.renderForm(this.state.form[t]),this.hideChatSection(),this.showFormSection(),this.showForm()}};onConnected=async t=>{if(this.hideAppStatus(),this.state.chat)return;if(this.showLoader(),this.state.form.ticket.enabled||await this.getForm("ticket"),this.state.form.prechat.enabled||await this.getForm("prechat"),this.state.form.postchat.enabled||await this.getForm("postchat"),await this.getPredictedAgent(),t?.customer&&t?.customer?.email)this.state.customer=t.customer;else{let e=await this.getCustomer();this.state.customer=e?.email&&e?.statistics?.chatsCount!==0?e:null}let s=await this.getListChats(),{chatsSummary:a,totalChats:i,users:r}=s;if(this.state.availability="online"===t.availability,this.state.totalChats=i,this.state.chat=a?.[0]?.id,this.state.active=a?.[0]?.active,this.state.lastThreadId=a?.[0]?.lastThreadId,this.state.isAgentAcceptingChat=t?.greeting?.accepted,this.state.currentForm=this.state.activeAgent?"prechat":"ticket",this.renderChat(),this.renderTranscriptModal(),this.buildinitialSelectors(),this.state.activeAgent&&this.renderAgentProfile(this.state.activeAgent),this.initPostEvents(),0!==i&&this.state.customer||(this.disableSendTranscript(),this.renderForm(this.state.form[this.state.currentForm]),this.hideChatSection(),this.showFormSection()),this.classList.remove("hidden"),_theme.isMobile&&this.elements.footerLoader&&(this.elements.footerLoader.classList.add("hide"),delete this.elements.footerLoader),0===i||!this.state.customer){this.hideLoader();return}if(this.state.lastThreadId&&this.state.active?(this.state.sendTranscript=!0,this.enableSendTranscript()):(this.state.sendTranscript=!1,this.disableSendTranscript()),this.showChatSection(),await this.loadInitialHistory(),await this.getRecentChat(),this.state.activeAgent){if(this.state.queue&&t?.greeting)this.hideAgent(),this.hideChatInput(),this.hideFormSection(),this.showQueueInfo();else if(this.hideQueueinfo(),this.state.active){if(this.showCloseChatBtn(),this.state.activeAgent){if(t?.greeting?.event){let n=this.buildThreadEventsMessage(t.greeting.event);n&&""!==n&&this.appendMessageHtml(n)}this.hideFormSection(),this.hideChatStartbtn(),this.showChatInput()}else this.hideChatInput(),this.renderForm(this.state.form.prechat),this.showFormSection(),this.showForm()}else if(this.hideCloseChatBtn(),this.state.activeAgent&&this.state.availability){if(t?.greeting?.event){let l=this.buildThreadEventsMessage(t.greeting.event);l&&""!==l&&this.appendMessageHtml(l)}this.hideFormSection(),this.hideChatInput(),this.showChatStartBtn()}else this.hideChatInput(),this.renderForm(this.state.form[this.state.currentForm]),this.showFormSection(),this.showForm()}else this.hideChatInput(),this.renderForm(this.state.form[this.state.currentForm]),this.showFormSection(),this.showForm();this.elements.chatCurrentThread=this.elements.chatList.querySelector(".message-thread.thread-active"),this.initOnScrollEvent(),this.hideLoader()};onQueuePosUpdated=t=>{this.state.queue=t,this.showQueueInfo()};onDisconnected=t=>{this.hideAgent(),this.showAppStatus(this.events.DISCONNECTED)};onConnectionLost=t=>{this.onDisconnected()};onConnectionUnstable=t=>{this.onDisconnected()};onConnectionRestored=t=>{this.showAppStatus(this.events.CONNECTION_RESTORED,!0)};onConnectionRecovered=t=>{this.showAppStatus(this.events.CONNECTION_RECOVERED,!0)};onCustomerId=t=>{this.state.customerId=t};onCustomerUpdated=t=>{this.state.customer=t};onUserData=t=>{this.state.users[t.id]=t};onUserRemovedFromChat=t=>{let{chatId:e,userId:s}={...t};e&&s&&(this.state.users=this.state.users.filter(t=>t.id!==s))};onIncomingEvent=t=>{if(!t.chatId)return;this.hideQueueinfo(),this.state.chat=t.chatId;let e=this.buildThreadEventsMessage(t.event);e&&""!==e&&this.appendMessageHtml(e),this.scrollToBottom(),this.state.soundEnable&&this.playNotificationSound()};getRecentChat=async()=>{if(!this.state.chat)return Promise.reject("No chat found");try{let t=await this.customerSDK.getChat({chatId:this.state.chat});if(this.state.lastThreadId=t.thread.id,this.state.active=t.thread.active,t.thread.queue&&t.thread.queue.position&&(this.state.queue=t.thread.queue),t.thread&&t.thread.userIds.length){let e=t.thread.userIds.filter(t=>this.isAgent({id:t}))[0];e&&(this.state.activeAgentId=e,this.state.activeAgent=this.state.users[e],this.state.isAgentOnline=!0)}return t}catch(s){this.handleError(s.message)}};onChatTrasferred=async t=>{let{chatId:e,threadId:s,transferredTo:a,reason:i}=t;if(e){this.state.chat=e;try{let r=await this.getRecentChat();if(r&&(this.state.lastThreadId=r.thread.id),r?.thread?.events?.length){let n=r.thread.events[r.thread.events.length-1];if("system_message"!==n.type)return;let l=this.buildThreadEventsMessage(n);l&&""!==l&&this.appendMessageHtml(l),this.scrollToBottom()}}catch(o){this.handleError(o.message)}}};onChatDeactivated=async t=>{if(t.chatId){this.state.chat=t.chatId,this.state.active=!1,this.hideQueueinfo(),this.hideChatInput(),this.hideCloseChatBtn(),this.resetSendTrasnscriptModal(),this.disableSendTranscript();try{let e=await this.getRecentChat();this.state.active=e?.thread?.active;let s=e?.thread?.events;s?.length&&s[s.length-1],this.state.chat?this.state.active?(this.renderForm(this.state.form.postchat),this.showForm(),this.showFormSection()):(this.renderForm(this.state.form.postchat),this.showFormSection(),this.showForm()):(this.renderForm(this.state.activeAgent?this.state.form.prechat:this.state.form.ticket),this.showForm(),this.showFormSection()),this.scrollToBottom()}catch(a){this.handleError(a.message),this.renderForm(this.state.isAgentAcceptingChat?this.state.form.prechat:this.state.form.ticket),this.showForm(),this.showFormSection(),this.scrollToBottom()}this.trapDialogueFocus()}};onAvailabilityUpdated=async t=>{let{availability:e}=t,s="online"===e;this.state.availability=s,0!==this.state.totalChats&&await this.getRecentChat(),await this.getPredictedAgent(),this.renderBaseOnStatus()};onEventUpdated=t=>{};onMarkSeen=t=>{if(!this.state.lastMsgId)return;let e=this.elements.chatList.querySelector(`.message-container.type-customer[data-id="${this.state.lastMsgId}"]`);if(!e)return;let s=e.classList.contains("type-file"),a=s?e.querySelector(".file-wrapper"):e.querySelector(".message-text");if(!a)return;let{chatId:i,userId:r}=t,n=this.isAgent({id:r});this.elements.chatList.querySelectorAll(".delivered, .seen").forEach(t=>{t.classList.remove("delivered"),t.classList.remove("seen")}),n?(a.classList.remove("delivered"),a.classList.add("seen"),this.alertStatus("Message seen by the agent")):(a.classList.add("delivered"),a.classList.remove("seen"),this.alertStatus("Message delivered successfully"))};playNotificationSound=()=>{let t=this.querySelector("[data-livechat-sound-player] audio");if(t&&t.play)try{t.play()}catch(e){}};showAppStatus=t=>{if(!t)return;let e=this.querySelector("[data-livechat-status]"),s="",a=!1;switch(t){case this.events.INACTIVITY_TIMEOUT:s="Inactivity Timeout";break;case this.events.USERS_LIMIT_REACHED:s="User limit reached";break;case this.events.ACCESS_TOKEN_EXPIRED:s="Access token expired";break;case this.events.CONNECTION_UNSTABLE:case this.events.DISCONNECTED:s="Disconnected",this.state.disConnected=!0;break;case this.events.CONNECTION_RESTORED:case this.events.CONNECTION_RECOVERED:s="Re-Connecting",a=!0;break;default:s="Something went wrong"}e.textContent=s,e.setAttribute("role","alert"),e.setAttribute("aria-hidden",!1),a&&setTimeout(this.hideAppStatus,2e3)};hideAppStatus=()=>{let t=this.querySelector("[data-livechat-status]");t&&(t.textContent="",t.removeAttribute("role"),t.setAttribute("aria-hidden",!0),this.state.disConnected&&(this.state.disConnected=!1,this.showAgent()))};handleError=t=>{this.hideLoader(),t&&this.state.isModelOpen&&(console.error(t),_theme.Helpers.showNotification(t))};getForm=async t=>{if(!t)return null;try{let e=await this.customerSDK.getForm({groupId:this.settings.groupId,type:t});if(this.state.form=this.state.form||{},this.state.form[t].enabled=e.enabled,this.state.form[t].id=e.form.id,this.state.form[t].fields=e.form.fields,"postchat"===t){let s=Number(this.state.form[t].fields[2].id);this.state.form[t].fields.some(t=>"rating"===t.type&&(t.options=[{label:"good",title:`<span class="visually-hidden">Rate as good</span>${_theme.liveChatIcons.like}`,checked:!1,value:1},{label:"bad",title:`<span class="visually-hidden">Rate as bad</span>${_theme.liveChatIcons.dislike}`,checked:!1,value:0}],!0)),this.state.form[t].fields.push({id:s?s+1:this.getCustomId("",!0),label:"Thank you for the rating! You can leave a comment in the box below:",required:!1,type:"comment"})}return _theme.Helpers.setItemIntoSS(`_livechat_${t}`,this.state.form[t]),e}catch(a){return this.handleError(a.message),null}};getCustomer=async()=>{try{let t=await this.customerSDK.getCustomer();return t}catch(e){this.handleError(e.message)}};noop=t=>{};isAgent=t=>t.id!==this.state.customerId;handleFormSubmit=async t=>{t.preventDefault();let e=this.validateForm(),s=this.elements.form.checkValidity();if(e.status&&s){if(0!==this.state.totalChats&&await this.getRecentChat(),["ticket","prechat"].includes(this.state.currentForm)){let a=!1;if(this.state.customer&&this.state.customer.email===e.email||(a=!0),a&&await this.updateCustomer(e),this.state.active&&await this.sendFormEvent(),"prechat"===this.state.currentForm&&this.state.activeAgent){await this.startChat();return}if(!this.state.active||"ticket"===this.state.currentForm||0===this.state.totalChats){let i=await this.createTicket();if("ticket"===this.state.currentForm||0===this.state.totalChats){this.displayTicketSuccessMsg(i);return}}}this.state.active&&await this.sendFormEvent(),"prechat"===this.state.currentForm&&(this.hideFormSection(),this.showChatSection(),this.state.active?(this.hideChatStartbtn(),this.showChatInput()):(this.hideChatInput(),this.showChatStartBtn())),"postchat"===this.state.currentForm&&(await this.sendAgentRating(Number(e.score),e.comment),await this.getPredictedAgent(),this.state.activeAgent?(this.hideFormSection(),this.showChatSection(),this.state.active?(this.hideChatStartbtn(),this.showChatInput()):(this.hideChatInput(),this.showChatStartBtn())):(this.hideChatInput(),this.hideChatStartbtn(),this.renderForm(this.state.form.ticket),this.showFormSection(),this.showForm()))}};sendFileMessage=async t=>{try{let{promise:e,cancel:s}=this.customerSDK.uploadFile({file:t,onProgress(t){}}),a=this.querySelector("#cancel-upload");a&&(a.onclick=s),this.updateSrOnlyContent("Please wait, uploading file");let i=this.getCustomId("file");this.showLoader();let r=await e;return await this.sendEvent({custom_id:i,type:"file",url:r.url,alternative_text:"file"}),this.appendMessage(this.createFileMessage(t,r.url)),this.hideFilePreviewModal(),this.hideLoader(),this.updateSrOnlyContent("File uploaded sucessfully"),this.state.uploadedFile=null,!0}catch(n){cancel(),this.state.uploadedFile=null,this.handleError(n.message)}};sendEvent=async t=>{if(!this.state.chat||!t)return Promise.reject("Chat id or event data is missing");try{let e=await this.customerSDK.sendEvent({chatId:this.state.chat,event:t});return e}catch(s){this.handleError(s.message)}};getFormData=()=>{let t=this.state.form[this.state.currentForm],e=[],s=t.fields.filter(t=>"header"!==t.type),a=this.state.form.elements,i=t.id;return s.forEach((s,i)=>{if(!this.settings.allowedInputTypes.includes(s.type))return;let r={};if(r.type=s.type,r.id=s.id||i,r.label=s.label,"postchat"===t.type){if("comment"===s.type);else{let n=this.elements.form.querySelector(`.form-group[data-id="${s.id}"] input:checked`);if(!n)return;let l=s.options.find(t=>t.label===n.value);"radio"===s.type?r.answer={id:l.id,label:n.value}:r.answer=n.dataset.val}}else r.answer=a[s.type].value;e.push(r)}),{formId:i,fields:e}};sendFormEvent=async()=>{let t=!!this.state.active||"postchat"===this.state.currentForm;if(t)try{let e=this.getFormData();return this.updateSrOnlyContent("Please wait, submitting form"),await this.sendEvent({type:"filled_form",custom_id:this.getCustomId("form-filled"),recipients:"agents",fields:e.fields,formId:e.formId}),this.updateSrOnlyContent("Submitted successfully"),!0}catch(s){return console.error(s),this.handleError(s.message),!1}};createTicket=async()=>{try{let t=this.getFormData(),e={groupId:this.settings.groupId,filledForm:{type:"filled_form",formId:t.formId,fields:t.fields}};this.showLoader(),this.updateSrOnlyContent("Please wait. creating a ticket");let s=await this.customerSDK.sendTicketForm(e);return this.hideLoader(),s}catch(a){this.handleError(a.message)}};updateCustomer=async t=>{try{return this.updateSrOnlyContent("Please wait, updating customer"),this.showLoader(),await this.customerSDK.updateCustomer({name:t.name,email:t.email}),this.updateSrOnlyContent("customer updated successfully"),this.state.customer=this.state.customer||{},this.state.customer.name=t.name,this.state.customer.email=t.email,this.hideLoader(),!0}catch(e){this.handleError(e.message)}};loadInitialHistory=async()=>{let t=this.state.chat;this.state.history=this.customerSDK.getChatHistory({chatId:t});let e=()=>this.loadHistory(t).then(()=>this.scrollToBottom());return e().catch(()=>e()).catch(this.noop)};loadHistory=t=>{if(this.state.history)return this.updateSrOnlyContent("fetching chat history"),new Promise((t,e)=>{this.state.historyStatus=this.historyStates.LOADING,this.state.history.next().then(({value:{threads:e},done:s})=>{if(s&&(this.state.wholeChatHistoryLoaded=!0),!e){this.updateSrOnlyContent("No history found");return}let a=this.elements.chatList;a.scrollHeight,a.scrollTop,a.clientHeight;let i=this.buildMessages(e),r=a.children[0];if(r){let n=document.createElement("div");n.innerHTML=i,n.childNodes.forEach(t=>{a.insertBefore(t,r)}),this.scrollToBottom(a.scrollHeight/10)}else a.innerHTML=i,this.scrollToBottom();this.state.historyStatus=s?this.historyStates.DONE:this.historyStates.INACTIVE,this.updateSrOnlyContent("chat history loaded successfully"),t()},t=>{this.state.historyStatus=this.historyStates.INACTIVE,e(t),this.updateSrOnlyContent("Something went wrong while fetching chat history")})})};buildMessages=t=>{if(!t||0===t.length)return"";let e=new Date().toISOString().split("T")[0],s="",a={},i=!1;t.forEach(t=>{let e=t.createdAt,s=e.split("T")[0];a[s]=a[s]||[],a[s].push({...t})});let r=Object.keys(a);if(r.forEach(t=>{let r=a[t],n=this.templates.thread,l="";l+=this.buildDateMessage(t),r.forEach(t=>{let{createdAt:e,events:s,nextThreadId:a,previousThreadId:i,properties:r}=t;s.forEach(t=>{let e=this.buildThreadEventsMessage(t);l+=e})});let o=e===t?"thread-active":"thread-archived";i||(i=e===t),n=_theme.Helpers.updateHtml(n,"[[Chat_Date]]",t),n=_theme.Helpers.updateHtml(n,"[[Chat_Thread_Html]]",l),s+=n=_theme.Helpers.updateHtml(n,"[[Chat_Thread_Class]]",o)}),this.elements.chatCurrentThread=this.elements.chatList.querySelector(".message-thread.thread-active"),s&&!i&&!this.elements.chatCurrentThread){let n=this.buildDateMessage(this.getCurrentDate()),l=_theme.Helpers.updateHtml(this.templates.thread,"[[Chat_Thread_Html]]",n);l=_theme.Helpers.updateHtml(l,"[[Chat_Date]]",e),s+=l=_theme.Helpers.updateHtml(l,"[[Chat_Thread_Class]]","thread-active")}return s};buildThreadEventsMessage=t=>{if(!t)return"";let{type:e}=t;return"filled_form"===e?this.getFormFilledHtml(t):"message"===e?this.getMessageHtml(t):"system_message"===e?this.getSystemMessageHtml(t):"file"===e?this.getFileMessageHtml(t):""};getFormFilledHtml=t=>{if("filled_form"!==t.type)return"";let e=t?.properties?.lc2?.form_type;if("prechat"===(e=e||(t.fields&&t.fields.length>3?"prechat":null))||"postchat"===e){let s="",a=this.templates.preChatForm,i="prechat"===e?_theme.liveChatIcons.user:_theme.liveChatIcons.star;return t.fields.forEach(t=>{let e=this.templates.preChatFormItem;e=_theme.Helpers.updateHtml(e,"[[Msg_Form_Input_Name]]",t.label),s+=e=_theme.Helpers.updateHtml(e,"[[Msg_Form_Input_Value]]",t.answer.label||t.answer)}),a=_theme.Helpers.updateHtml(a,"[[Form_Type]]",e),a=_theme.Helpers.updateHtml(a,"[[Form_Icon]]",i),a=_theme.Helpers.updateHtml(a,"[[Msg_Form_Input_Items]]",s)}return"ticket"===e?this.templates.ticketFormOffline:""};getMessageHtml=t=>{if("message"!==t.type)return"";let e=this.templates.message,s=this.state.users[t.authorId],a=s.avatar?`<img class="agent-avatar" src="${s.avatar}" alt="avatar" aria-hidden="true" />`:"";return e=_theme.Helpers.updateHtml(e,"[[Msg_Id]]",t.id),e=_theme.Helpers.updateHtml(e,"[[Msg_TypeClass]]",this.isAgent(s)?"type-agent":"type-customer"),e=_theme.Helpers.updateHtml(e,"[[Msg_Avatar]]",a),e=_theme.Helpers.updateHtml(e,"[[Msg_User_Name]]",`<span>${s.name}</span>`),e=_theme.Helpers.updateHtml(e,"[[Msg_Timestamp]]",`<span>${_theme.Helpers.getFormattedTime(t.createdAt)}</span>`),e=_theme.Helpers.updateHtml(e,"[[Msg_ChatText]]",t.text)};getSystemMessageHtml=t=>{if("system_message"!==t.type)return"";let e=t?.systemMessageType,s=t?.text||"";"rating.chat_rated"===e&&(s=`You rated the chat as ${t?.textVars?.score}`),"rating.chat_commented"===e&&(s=`You left the following comment: ${t?.textVars?.comment}`),"routing.assigned_inactive"===e&&(s="You have been transferred to: "+t?.textVars?.agent_added+"."),"routing.archived_inactive"===e&&(s="The chat has been closed due to long user inactivity."),("archived_customer_disconnected"===e||"manual_archived_customer"===e)&&(s="You have closed the chat"),"manual_archived_agent"===e&&(s=`${t?.textVars?.agent} has closed the chat.`);let a=_theme.Helpers.updateHtml(this.templates.systemMsg,"[[Msg_Text]]",s);return a};getFileMessageHtml=t=>{if("file"!==t.type)return"";let e=this.isAgent({id:t.authorId});return this.createFileMessage({type:t.contentType,name:t.name},t.url,!0,e)};buildDateMessage=t=>{if(!t)return"";let e=this.templates.threadStartDate;return _theme.Helpers.updateHtml(e,"[[Msg_Thread_Start_Date]]",_theme.Helpers.getFormattedDate(t))};getMessagesFromThreads=t=>t.map(({events:t})=>t||[]).reduce((t,e)=>[...t,...e],[]).filter(t=>"message"===t.type).map(t=>{let e=this.state.users[t.authorId];return this.createMessage(t.id,t.text,e,t.createdAt)});getCurrentDate=()=>new Date().toISOString();getCustomId=(t,e)=>{let s="";switch(t){case"form":s="form-";break;case"form-filled":s="form-filled-";break;case"msg":s="msg-";break;default:s="livechat-"}return e&&(s=""),`${s}${Math.floor(1e7*Math.random())}`};getListChats=async()=>{try{let t=await this.customerSDK.listChats();return t}catch(e){this.handleError(e.message)}};sendTranscript=async t=>{if(this.state.chat&&this.state.customer&&this.state.lastThreadId)try{if(await this.getRecentChat(),!this.state.lastThreadId)return Promise.reject("No active thread found");await this.customerSDK.updateThreadProperties({chatId:this.state.chat,threadId:this.state.lastThreadId,properties:{routing:{transcript_email:t||this.state.customer.email}}})}catch(e){this.handleError(e.message)}};sendAgentRating=async(t,e)=>{if(this.state.chat&&void 0!==t)try{this.updateSrOnlyContent("Please wait. submitting agent rating");let s={chatId:this.state.chat,rating:{score:t,comment:e||""}},a=await this.customerSDK.rateChat(s);return this.updateSrOnlyContent("submitted successfully"),a}catch(i){return this.handleError(i.message),!1}};onUserAddedToChat=t=>{this.handleChatStart(t)};getMessageHtmlFromThread=t=>{if(!t)return"";let e="";return this.elements.chatCurrentThread=this.elements.chatCurrentThread||this.querySelector("[data-chat-list] .message-thread.thread-active"),this.elements.chatCurrentThread?t.events.forEach(t=>{let s=this.buildThreadEventsMessage(t);e+=s}):e=this.buildMessages([t]),e};appendMessageHtml=t=>{if(!t)return;let e=document.createElement("div");e.innerHTML=t,e.childNodes.forEach(t=>{this.appendMessage(t)})};handleChatStart=async t=>{this.hideAppStatus();let{chat:e,chatId:s}=t;if(e||s||(e=t),this.state.chat=s||e.id,this.state.historyStatus=this.historyStates.DONE,this.state.active=!0,this.state.activating=!1,this.state.pendingMessages=[],e?.thread?.queue){this.state.queue=e?.thread?.queue,this.hideAgent(),this.hideChatInput(),this.hideFormSection(),this.showQueueInfo(),this.hideChatStartbtn(),this.trapDialogueFocus();return}if(this.hideQueueinfo(),this.enableSendTranscript(),this.renderTranscriptModal(),this.hideChatStartbtn(),this.showCloseChatBtn(),this.hideFormSection(),this.showChatSection(),this.showChatInput(),t.present&&t.user){this.state.activeAgentId=t.user.id,this.state.activeAgent=t.user,this.state.isAgentOnline=!0,this.renderAgentProfile(t.user,!0),this.scrollToBottom(),this.trapDialogueFocus();return}if(e.thread&&e.thread.userIds.length){let a=e.thread.userIds.filter(t=>this.isAgent({id:t}))[0];a&&(this.state.activeAgentId=a,this.state.activeAgent=this.state.users[a],this.state.isAgentOnline=!0,this.renderAgentProfile(this.state.activeAgent))}this.state.totalChats=this.state.totalChats||1,this.appendMessageHtml(this.getMessageHtmlFromThread(e.thread)),this.scrollToBottom(),this.state.soundEnable&&this.playNotificationSound(),e?.thread?.events?.[0]?.type==="message"&&this.alertStatus(`Message received from the agent ${this.state.activeAgent.name}. ${e?.thread?.events?.[0].text}`),this.trapDialogueFocus()};sendMessage=async(t,e,s)=>{try{let a={customId:e,text:s,type:"message"};return await this.customerSDK.sendEvent({chatId:t,event:a}),this.confirmMessageAsSent(e),!0}catch(i){this.handleError(i.message),this.markAsFailedMessage(e)}};resumeChat=async()=>{try{this.state.activating=!0;let t={chat:{...this.state.chat&&{id:this.state.chat},thread:{events:this.state.pendingMessages.map(t=>({type:"message",text:t.message,customId:t.id}))}}},e=await this.customerSDK.startChat(t);return e}catch(s){this.handleError(s.message)}};startChat=async()=>{try{this.state.activating=!0;let t={chat:{...this.state.chat&&{id:this.state.chat},thread:{events:this.state.pendingMessages.map(t=>({type:"message",text:t.message,customId:t.id}))}}},e=this.state.chat?this.customerSDK.resumeChat:this.customerSDK.startChat,s=await e(t);this.handleChatStart(s)}catch(a){this.handleError(a.message),this.state.activating=!1,this.state.pendingMessages.forEach(({messageId:t})=>this.markAsFailedMessage(t)),this.state.pendingMessages=[]}};onChatInputPressEnter=t=>{13===t.which&&(t.preventDefault(),this.handleMessage())};handleMessage=async()=>{let t=this.elements.chatInput.value.trim();if(this.elements.chatInput.value="",!t)return;let e=`${Math.floor(1e7*Math.random())}`;this.state.lastMsgId=e,this.state.active?await this.sendMessage(this.state.chat,e,t):(this.state.activating||this.startChat(),this.state.pendingMessages.push({messageId:e,text:t}));let s=this.state.users[this.state.customerId];this.appendMessage(this.createMessage(e,t,s,this.getCurrentDate())),this.scrollToBottom()}}customElements.get(AppLiveChat.getElementName)||customElements.define(AppLiveChat.getElementName,AppLiveChat);